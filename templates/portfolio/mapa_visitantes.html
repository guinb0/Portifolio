{% extends 'portfolio/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="{% static 'css/map.css' %}">
{% endblock %}

{% block content %}
<div class="map-container">
    <div class="map-content">
        <div class="map-header">
            <h1><i class='bx bx-world'></i>
                {% if language == 'en' %}Visitor Map{% elif language == 'es' %}Mapa de Visitantes{% else %}Mapa de Visitantes{% endif %}
            </h1>
            <p>
                {% if language == 'en' %}Visitors from around the world who accessed this portfolio{% elif language == 'es' %}Visitantes de todo el mundo que accedieron a este portafolio{% else %}Visitantes do mundo todo que acessaram este portfólio{% endif %}
            </p>
        </div>
        
        <div id="visitor-map"></div>
        
        <div class="map-stats">
            <div class="stat-card">
                <i class='bx bx-user'></i>
                <h3 id="total-visitors">-</h3>
                <p>
                    {% if language == 'en' %}Total Visitors{% elif language == 'es' %}Visitantes Totales{% else %}Total de Visitantes{% endif %}
                </p>
            </div>
            <div class="stat-card">
                <i class='bx bx-world'></i>
                <h3 id="total-countries">-</h3>
                <p>{% if language == 'en' %}Countries{% elif language == 'es' %}Países{% else %}Países{% endif %}</p>
            </div>
            <div class="stat-card">
                <i class='bx bx-map-pin'></i>
                <h3 id="total-cities">-</h3>
                <p>{% if language == 'en' %}Cities{% elif language == 'es' %}Ciudades{% else %}Cidades{% endif %}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Registra o visitante primeiro
    registerVisitor();
    
    // Inicializa o mapa sem controle padrão de zoom para reposicionar
    const map = L.map('visitor-map', { zoomControl: false }).setView([0, 0], 2);
    
    // Adiciona camada de tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 18
    }).addTo(map);

    // Adiciona controle de zoom reposicionado para evitar conflito com navbar (bottomright)
    L.control.zoom({ position: 'bottomright' }).addTo(map);
    
    // Ícone personalizado para marcadores
    const customIcon = L.divIcon({
        className: '',
        html: '<div class="map-marker"></div>',
        iconSize: [18, 18],
        iconAnchor: [9, 9]
    });
    
    // Função para registrar o visitante
    function registerVisitor() {
        fetch('{% url "portfolio:register_visitor" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Visitante registrado:', data);
            // Após registrar, carrega os dados do mapa
            loadMapData();
        })
        .catch(error => {
            console.error('Erro ao registrar visitante:', error);
            // Mesmo com erro, tenta carregar o mapa
            loadMapData();
        });
    }
    
    // Função para carregar dados do mapa
    function loadMapData() {
        fetch('{% url "portfolio:visitor_data_api" %}')
            .then(response => response.json())
            .then(data => {
                const locations = data.locations;
                const summary = data.summary;
                
                // Adiciona marcadores ao mapa
                locations.forEach(location => {
                    const marker = L.marker([location.latitude, location.longitude], {
                        icon: customIcon
                    }).addTo(map);
                    
                    // Popup com informações
                    const popupContent = `
                        <div style="text-align: center;">
                            <strong>${location.city || 'Desconhecido'}, ${location.region || ''}</strong><br>
                            <span style="color: var(--text-light);">${location.country}</span><br>
                            <small>Visitantes: ${location.count}</small><br>
                            <small>Última visita: ${new Date(location.last_visit).toLocaleDateString('pt-BR')}</small>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                });
                
                // Atualiza estatísticas (visitantes únicos por IP)
                const totalUniqueIPs = summary ? summary.unique_ips_global : locations.reduce((sum, loc) => sum + loc.unique_ips, 0);
                const uniqueCountries = new Set(locations.map(loc => loc.country)).size;
                const uniqueCities = new Set(locations.map(loc => `${loc.city}, ${loc.country}`)).size;

                document.getElementById('total-visitors').textContent = totalUniqueIPs;
                document.getElementById('total-countries').textContent = uniqueCountries;
                document.getElementById('total-cities').textContent = uniqueCities;
                
                // Mantém visão mundial inicial, não ajusta bounds
            })
            .catch(error => {
                console.error('Erro ao carregar dados dos visitantes:', error);
            });
    }
});
</script>
{% endblock %}